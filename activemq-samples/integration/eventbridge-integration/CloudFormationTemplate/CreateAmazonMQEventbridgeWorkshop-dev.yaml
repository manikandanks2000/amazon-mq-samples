AWSTemplateFormatVersion: '2010-09-09'
Description: AWS CloudFormation template to launch resources for the Amazon MQ workshop.

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: General Configuration
        Parameters:
          - CIDR
      - Label:
          default: Broker Configuration
        Parameters:
          - AmazonMQBrokerUser
          - AmazonMQBrokerPassword
      - Label:
          default: Workshop Studio configuration - DO NOT CHANGE, ONLY FOR AWS RAN EVENTS
        Parameters:
          - IsWorkshopStudioEnv
          - ParticipantRoleArn
          - InstanceOwner
    ParameterLabels:
      IsWorkshopStudioEnv:
        default: Parameter showing CloudFormation is being run at an AWS event when "yes"
      ParticipantRoleArn:
        default: Populated automatically or left blank
      InstanceOwner:
        default: Populated automatically or left blank
      AmazonMQBrokerUser:
        default: Broker Username
      AmazonMQBrokerPassword:
        default: Broker Password
      
Parameters:
  IsWorkshopStudioEnv:
    Type: String
    Default: "no"
    AllowedValues:
      - "no"
      - "yes"
    Description: Whether this stack is being deployed in a Workshop Studio environment or not. If not sure, leave as default of "no".
  ParticipantRoleArn:
    Description: Participant Role Arn
    Type: String
  InstanceOwner:
    Description: Cloud9 InstanceOwner
    Type: String
  Stage:
    Type: String
    Default: DEV
    Description: The stage into we deploy this template.
  CIDR:
    Description: CIDR block, from which the access to the EC2 instance is allowed.
    Type: String
    Default: '0.0.0.0/0'
    MinLength: 1
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: The CIDR block is required!
  AmazonMQBrokerUser:
    Description: The user to access the Amazon MQ broker.
    Type: String
    Default: workshopUser
    MinLength: 2
    ConstraintDescription: The Amazon MQ broker user is required !
  AmazonMQBrokerPassword:
    Description: The password to access the Amazon MQ broker. Min 12 characters
    Type: String
    Default: workshopUser
    MinLength: 12
    ConstraintDescription: The Amazon MQ broker password is required !
    NoEcho: true
  IBMMQBrokerPassword:
    NoEcho: true
    Type: String
    Default: passw0rd
    Description: The password of the IBM MQ application user.
  IBMMQBrokerQueueManager:
    Type: String
    Default: QMGR
    Description: The IBM MQ broker queue manager name.
  LatestAmiId:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Default: '/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64'
Conditions:
  IsWS: !Equals 
    - !Ref IsWorkshopStudioEnv
    - "yes"

Resources:
  ECSTaskRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: [ecs-tasks.amazonaws.com]
          Action: ['sts:AssumeRole']
      Path: /
      Policies:
        - PolicyName: ECSTaskRolePolicy
          PolicyDocument:
            Statement:
            - Effect: Allow
              Action:
                - ssm:GetParameter
                - kms:Decrypt
              Resource: '*'

  ServiceAutoScalingRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: application-autoscaling.amazonaws.com
            Action: sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: fargate-service-autoscaling
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - application-autoscaling:*
                  - cloudwatch:DescribeAlarms
                  - cloudwatch:PutMetricAlarm
                  - ecs:DescribeServices
                  - ecs:UpdateService
                Resource: '*'

  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.42.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Join
            - '-'
            - - !Ref 'AWS::StackName'
              - VPC
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Join
            - '-'
            - - !Ref 'AWS::StackName'
              - InternetGateway
  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref 'VPC'
      InternetGatewayId: !Ref 'InternetGateway'
  RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref 'VPC'
      Tags:
        - Key: Name
          Value: !Join
            - '-'
            - - !Ref 'AWS::StackName'
              - RouteTable
  Route:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref 'RouteTable'
      DestinationCidrBlock: '0.0.0.0/0'
      GatewayId: !Ref 'InternetGateway'
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref 'VPC'
      CidrBlock: 10.42.0.0/24
      AvailabilityZone: !Select
        - '0'
        - !GetAZs ''
      Tags:
        - Key: Name
          Value: !Join
            - '-'
            - - !Ref 'AWS::StackName'
              - PublicSubnet1
  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref 'VPC'
      CidrBlock: 10.42.1.0/24
      AvailabilityZone: !Select
        - '1'
        - !GetAZs ''
      Tags:
        - Key: Name
          Value: !Join
            - '-'
            - - !Ref 'AWS::StackName'
              - PublicSubnet2
  PublicSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref 'VPC'
      CidrBlock: 10.42.2.0/24
      AvailabilityZone: !Select
        - '2'
        - !GetAZs ''
      Tags:
        - Key: Name
          Value: !Join
            - '-'
            - - !Ref 'AWS::StackName'
              - PublicSubnet3
  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref 'PublicSubnet1'
      RouteTableId: !Ref 'RouteTable'
  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref 'PublicSubnet2'
      RouteTableId: !Ref 'RouteTable'
  PublicSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref 'PublicSubnet3'
      RouteTableId: !Ref 'RouteTable'
  AmazonMQSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Limits security group ingress and egress traffic for the Amazon
        MQ instance
      VpcId: !Ref 'VPC'
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8162
          ToPort: 8162
          CidrIp: !Ref 'CIDR'
        - IpProtocol: tcp
          FromPort: 61617
          ToPort: 61617
          CidrIp: !Ref 'CIDR'
        - IpProtocol: tcp
          FromPort: 5671
          ToPort: 5671
          CidrIp: !Ref 'CIDR'
        - IpProtocol: tcp
          FromPort: 61614
          ToPort: 61614
          CidrIp: !Ref 'CIDR'
        - IpProtocol: tcp
          FromPort: 8883
          ToPort: 8883
          CidrIp: !Ref 'CIDR'
      Tags:
        - Key: Name
          Value: !Join
            - '-'
            - - !Ref 'AWS::StackName'
              - AmazonMQSecurityGroup
  JmsBridgeSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Limits security group ingress and egress traffic for the JMS bridge
      VpcId: !Ref VPC
      SecurityGroupEgress:
      - IpProtocol: tcp
        FromPort: 8162
        ToPort: 8162
        DestinationSecurityGroupId: !Ref IBMMQSecurityGroup
  IBMMQSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Limits security group ingress and egress traffic for the WebSphere MQ instance
      VpcId: !Ref VPC
      SecurityGroupIngress:
      - IpProtocol: tcp
        FromPort: 9443
        ToPort: 9443
        CidrIp: 0.0.0.0/0
      - IpProtocol: tcp
        FromPort: 1414
        ToPort: 1414
        CidrIp: 0.0.0.0/0             
  AmazonMQBrokerLarge:
    Type: AWS::AmazonMQ::Broker
    DependsOn: AttachGateway
    Properties:
      BrokerName: Broker
      EngineType: ActiveMQ
      EngineVersion: 5.18
      HostInstanceType: mq.m5.large
      DeploymentMode: ACTIVE_STANDBY_MULTI_AZ
      PubliclyAccessible: true
      AutoMinorVersionUpgrade: true
      SecurityGroups:
        - !Ref 'AmazonMQSecurityGroup'
      SubnetIds:
        - !Ref 'PublicSubnet1'
        - !Ref 'PublicSubnet2'
      Logs:
        Audit: true
        General: true
      Users:
        - ConsoleAccess: true
          Groups:
            - admin
          Username: !Ref 'AmazonMQBrokerUser'
          Password: !Ref 'AmazonMQBrokerPassword'
  Broker1:
    Properties:
      BrokerName: NoB1
      DeploymentMode: ACTIVE_STANDBY_MULTI_AZ
      EngineType: ACTIVEMQ
      EngineVersion: 5.18
      HostInstanceType: mq.t3.micro
      Logs:
        Audit: true
        General: true
      PubliclyAccessible: true
      AutoMinorVersionUpgrade: true
      SecurityGroups:
        - !Ref 'AmazonMQSecurityGroup'
      SubnetIds:
        - !Ref 'PublicSubnet1'
        - !Ref 'PublicSubnet2'
      Users:
        - ConsoleAccess: true
          Groups:
            - admin
          Username: !Ref 'AmazonMQBrokerUser'
          Password: !Ref 'AmazonMQBrokerPassword'
    Type: AWS::AmazonMQ::Broker
    DependsOn: AttachGateway
  Broker2:
    Properties:
      AutoMinorVersionUpgrade: true
      BrokerName: NoB2
      DeploymentMode: ACTIVE_STANDBY_MULTI_AZ
      EngineType: ACTIVEMQ
      EngineVersion: 5.18
      HostInstanceType: mq.t3.micro
      Logs:
        Audit: true
        General: true
      PubliclyAccessible: true
      SecurityGroups:
        - !Ref 'AmazonMQSecurityGroup'
      SubnetIds:
        - !Ref 'PublicSubnet2'
        - !Ref 'PublicSubnet3'
      Users:
        - ConsoleAccess: true
          Groups:
            - admin
          Username: !Ref 'AmazonMQBrokerUser'
          Password: !Ref 'AmazonMQBrokerPassword'
    Type: AWS::AmazonMQ::Broker
    DependsOn: AttachGateway
  Broker3:
    Properties:
      AutoMinorVersionUpgrade: true
      BrokerName: NoB3
      DeploymentMode: ACTIVE_STANDBY_MULTI_AZ
      EngineType: ACTIVEMQ
      EngineVersion: 5.18
      HostInstanceType: mq.t3.micro
      Logs:
        Audit: true
        General: true
      PubliclyAccessible: true
      SecurityGroups:
        - !Ref 'AmazonMQSecurityGroup'
      SubnetIds:
        - !Ref 'PublicSubnet1'
        - !Ref 'PublicSubnet3'
      Users:
        - ConsoleAccess: true
          Groups:
            - admin
          Username: !Ref 'AmazonMQBrokerUser'
          Password: !Ref 'AmazonMQBrokerPassword'
    Type: AWS::AmazonMQ::Broker
    DependsOn: AttachGateway
  AmazonMQBrokerMigration:
    Type: AWS::AmazonMQ::Broker
    Properties: 
      BrokerName: AmazonMQBrokerMigration
      DeploymentMode: SINGLE_INSTANCE
      EngineType: ActiveMQ
      EngineVersion: 5.18
      HostInstanceType: mq.m5.large
      Logs:
        General: true
        Audit: true
      PubliclyAccessible: true
      SecurityGroups:
        - !Ref AmazonMQSecurityGroup
      SubnetIds:
        - !Ref PublicSubnet1
      Users: 
        - ConsoleAccess: true
          Groups: 
            - admin
          Username: !Ref 'AmazonMQBrokerUser'
          Password: !Ref 'AmazonMQBrokerPassword'                                                                                                                                       
  Configuration1:
    Properties:
      Data:
        Fn::Base64:
          Fn::Join:
          - ''
          - - |-
              <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
              <broker xmlns="http://activemq.apache.org/schema/core"
                      schedulePeriodForDestinationPurge="10000"
                      start="false">
                <!--
                A configuration contains all of the settings for your ActiveMQ broker, in XML format (similar to ActiveMQ's activemq.xml file).
                You can create a configuration before creating any brokers. You can then apply the configuration to one or more brokers.

                You can use additional attributes for the broker element above. These attributes allow you to configure broker-wide settings.

                For more information, see Configuration and Amazon MQ Broker Configuration Parameters in the Amazon MQ Developer Guide:
                https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/amazon-mq-broker-configuration-parameters.html
                -->
                <!--
                Mirrored queues let you send a copy of each message to a topic with a similar name automatically.
                For more information, see http://activemq.apache.org/mirrored-queues.html

                Virtual destinations let you configure advanced routing of messages between destinations.
                For more information, see http://activemq.apache.org/virtual-destinations.html
                -->
                <!--
                <destinationInterceptors>
                  <mirroredQueue copyMessage="true" postfix=".qmirror" prefix=""/>
                  <virtualDestinationInterceptor>
                    <virtualDestinations>
                      <virtualTopic name="&gt;" prefix="VirtualTopicConsumers.*." selectorAware="false"/>
                      <compositeQueue name="MY.QUEUE">
                        <forwardTo>
                          <queue physicalName="FOO"/>
                          <topic physicalName="BAR"/>
                        </forwardTo>
                      </compositeQueue>
                    </virtualDestinations>
                  </virtualDestinationInterceptor>
                </destinationInterceptors>
                -->
                <!--
                By default, Amazon MQ optimizes for queues with fast consumers:
                Consumers are considered fast if they are able to keep up with the rate of messages generated by producers.
                Consumers are considered slow if a queue builds up a backlog of unacknowledged messages, potentially causing a decrease in producer throughput.
                To instruct Amazon MQ to optimize for queues with slow consumers, set the concurrentStoreAndDispatchQueues attribute to false.
                For more information, see https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/ensuring-effective-amazon-mq-performance.html
                -->
                <!--
                <persistenceAdapter>
                  <kahaDB  concurrentStoreAndDispatchQueues="false"/>
                </persistenceAdapter>
                -->
                <destinationPolicy>
                    <policyMap>
                       <policyEntries>
                      <!--
                      gcInactiveDestinations is used to automatically purge inactive destinations
                      preventing them from unnecessarily using broker resources.

                      An 'inactive' destination is one that has no messages pending and no consumers connected.

                      For more information, see: http://activemq.apache.org/delete-inactive-destinations.html
                      -->
                          <policyEntry gcInactiveDestinations="true"
                                       inactiveTimoutBeforeGC="600000"
                                       topic="&gt;">
                        <!--
                        The constantPendingMessageLimitStrategy is used to prevent
                        slow topic consumers to block producers and affect other consumers
                        by limiting the number of messages that are retained

                        For more information, see: http://activemq.apache.org/slow-consumer-handling.html
                        -->
                             <pendingMessageLimitStrategy>
                                <constantPendingMessageLimitStrategy limit="1000"/>
                             </pendingMessageLimitStrategy>
                          </policyEntry>
                          <policyEntry gcInactiveDestinations="true"
                                       inactiveTimoutBeforeGC="600000"
                                       queue="&gt;"/>
                          <!--
                      Destination policies let you configure a rich set of behaviors for your queues and topics.
                      For more information, see http://activemq.apache.org/per-destination-policies.html
                      -->
                          <!--
                      <policyEntry topic="FOO.&gt;">
                        <dispatchPolicy>
                          <roundRobinDispatchPolicy/>
                        </dispatchPolicy>
                        <subscriptionRecoveryPolicy>
                          <lastImageSubscriptionRecoveryPolicy/>
                        </subscriptionRecoveryPolicy>
                      </policyEntry>
                      <policyEntry advisoryForConsumed="true" tempTopic="true"/>
                      <policyEntry advisoryForConsumed="true" tempQueue="true"/>
                      -->
                       </policyEntries>
                    </policyMap>
                </destinationPolicy>
                <!--
                Typically, destinations are created automatically when they are used. Amazon MQ lets you create destinations when the broker is started.
                For more information, see http://activemq.apache.org/configure-startup-destinations.html
                -->
                <!--
                <destinations>
                  <queue physicalName="FOO.BAR"/>
                  <topic physicalName="SOME.TOPIC"/>
                </destinations>
                -->
                <!--
                You can control advanced ActiveMQ features using plugins.
                -->
                <plugins>
                  <!--
                  The Authorization plugin allows you to control the groups of users that are allowed to perform certain operations on your destinations.
                  For more information, see http://activemq.apache.org/security.html
                  -->
                  <!--
                  <authorizationPlugin>
                    <map>
                      <authorizationMap>
                        <authorizationEntries>
                          <authorizationEntry admin="guests,users" queue="GUEST.&gt;" read="guests" write="guests,users"/>
                          <authorizationEntry admin="guests,users" read="guests,users" topic="ActiveMQ.Advisory.&gt;" write="guests,users"/>
                        </authorizationEntries>
                        <tempDestinationAuthorizationEntry>
                          <tempDestinationAuthorizationEntry admin="tempDestinationAdmins" read="tempDestinationAdmins" write="tempDestinationAdmins"/>
                        </tempDestinationAuthorizationEntry>
                      </authorizationMap>
                    </map>
                  </authorizationPlugin>
                  -->
                  <!--
                  The Discarding DLQ plugin simplifies the configuration of your global dead-letter queue strategy.
                  You can take advantage of a more granular per-destination control by using destination policies.
                  For more information, see http://activemq.apache.org/message-redelivery-and-dlq-handling.html
                  -->
                  <!--
                  <discardingDLQBrokerPlugin dropAll="true" dropTemporaryQueues="true" dropTemporaryTopics="true"/>
                  -->
                  <!--
                  The Force Persistency Mode plugin can override the persistency mode set on messages.
                  -->
                  <!--
                  <forcePersistencyModeBrokerPlugin persistenceFlag="true"/>
                  -->
                  <!--
                  The Redelivery plugin extends the capabilities of destination policies with respect to message redelivery.
                  For more information, see http://activemq.apache.org/message-redelivery-and-dlq-handling.html
                  -->
                  <!--
                  <redeliveryPlugin fallbackToDeadLetter="true" sendToDlqIfMaxRetriesExceeded="true">
                    <redeliveryPolicyMap>
                      <redeliveryPolicyMap>
                        <redeliveryPolicyEntries>
                          <redeliveryPolicy maximumRedeliveries="4" queue="SpecialQueue" redeliveryDelay="10000"/>
                        </redeliveryPolicyEntries>
                        <defaultEntry>
                          <redeliveryPolicy initialRedeliveryDelay="5000" maximumRedeliveries="4" redeliveryDelay="10000"/>
                        </defaultEntry>
                      </redeliveryPolicyMap>
                    </redeliveryPolicyMap>
                  </redeliveryPlugin>
                  -->
                  <!--
                  The Statistics plugin lets you query broker or destination statistics by sending messages to the broker.
                  For more information, see http://activemq.apache.org/statisticsplugin.html
                  -->
                  <!--
                  <statisticsBrokerPlugin/>
                  -->
                  <!--
                  The Timestamping plugin lets the broker use server-side time instead of client-provided time for messages.
                  For more information, see http://activemq.apache.org/timestampplugin.html
                  -->
                  <!--
                  <timeStampingBrokerPlugin ttlCeiling="86400000" zeroExpirationOverride="86400000"/>
                  -->
                </plugins>
                <!--
                Network connectors let you connect brokers into networks of brokers.
                For more information, see Creating and Configuring an Amazon MQ Network of Brokers
                (https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/amazon-mq-creating-configuring-network-of-brokers.html)
                in the Amazon MQ Developer Guide and also Networks of Brokers
                (http://activemq.apache.org/networks-of-brokers.html) in the ActiveMQ documentation.
                -->
                <!--
                <networkConnectors>
                  <networkConnector name="myNetworkConnector" userName="commonUser" uri="masterslave:(ssl://b-1a2b3c4d-1.mq.region.amazonaws.com:61617,ssl://b-1a2b3c4d-2.mq.region.amazonaws.com:61617)"/>
                </networkConnectors>
                -->
                 <networkConnectors>
                    <networkConnector conduitSubscriptions="false"
                                      consumerTTL="1"
                                      messageTTL="-1"
                                      name="QueueConnector_ConnectingBroker_1_To_2"
                                      uri="masterslave:(
            - Fn::Select:
              - 0
              - Fn::GetAtt:
                - Broker2
                - OpenWireEndpoints
            - ','
            - Fn::Select:
              - 1
              - Fn::GetAtt:
                - Broker2
                - OpenWireEndpoints
            - |-
              )"
                       userName="
            - !Ref 'AmazonMQBrokerUser'
            - |-
              ">
                       <excludedDestinations>
                          <topic physicalName="&gt;"/>
                       </excludedDestinations>
                    </networkConnector>
                    <networkConnector conduitSubscriptions="true"
                                      consumerTTL="1"
                                      messageTTL="-1"
                                      name="TopicConnector_ConnectingBroker_1_To_2"
                                      uri="masterslave:(
            - Fn::Select:
              - 0
              - Fn::GetAtt:
                - Broker2
                - OpenWireEndpoints
            - ','
            - Fn::Select:
              - 1
              - Fn::GetAtt:
                - Broker2
                - OpenWireEndpoints
            - |-
              )"
                                      userName="
            - !Ref 'AmazonMQBrokerUser'
            - |-
              ">
                       <excludedDestinations>
                          <queue physicalName="&gt;"/>
                       </excludedDestinations>
                    </networkConnector>
                    <networkConnector conduitSubscriptions="false"
                                      consumerTTL="1"
                                      messageTTL="-1"
                                      name="QueueConnector_ConnectingBroker_1_To_3"
                                      uri="masterslave:(
            - Fn::Select:
              - 0
              - Fn::GetAtt:
                - Broker3
                - OpenWireEndpoints
            - ','
            - Fn::Select:
              - 1
              - Fn::GetAtt:
                - Broker3
                - OpenWireEndpoints
            - |-
              )"
                                      userName="
            - !Ref 'AmazonMQBrokerUser'
            - |-
              ">
                       <excludedDestinations>
                          <topic physicalName="&gt;"/>
                       </excludedDestinations>
                    </networkConnector>
                    <networkConnector conduitSubscriptions="true"
                                      consumerTTL="1"
                                      messageTTL="-1"
                                      name="TopicConnector_ConnectingBroker_1_To_3"
                                      uri="masterslave:(
            - Fn::Select:
              - 0
              - Fn::GetAtt:
                - Broker3
                - OpenWireEndpoints
            - ','
            - Fn::Select:
              - 1
              - Fn::GetAtt:
                - Broker3
                - OpenWireEndpoints
            - |-
              )"
                                      userName="
            - !Ref 'AmazonMQBrokerUser'
            - |
              ">
                       <excludedDestinations>
                          <queue physicalName="&gt;"/>
                       </excludedDestinations>
                    </networkConnector>
                 </networkConnectors>
                 <transportConnectors>
                    <transportConnector name="openwire" updateClusterClients="true" rebalanceClusterClients="true" updateClusterClientsOnRemove="true"/>
                 </transportConnectors>                 
              </broker>
      Description: Generated configuration to build a network of brokers.
      EngineType: ACTIVEMQ
      EngineVersion: 5.18
      Name: NoB1Configuration
    Type: AWS::AmazonMQ::Configuration
  Configuration2:
    Properties:
      Data:
        Fn::Base64:
          Fn::Join:
          - ''
          - - |-
              <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
              <broker xmlns="http://activemq.apache.org/schema/core"
                      schedulePeriodForDestinationPurge="10000"
                      start="false">
                <!--
                A configuration contains all of the settings for your ActiveMQ broker, in XML format (similar to ActiveMQ's activemq.xml file).
                You can create a configuration before creating any brokers. You can then apply the configuration to one or more brokers.

                You can use additional attributes for the broker element above. These attributes allow you to configure broker-wide settings.

                For more information, see Configuration and Amazon MQ Broker Configuration Parameters in the Amazon MQ Developer Guide:
                https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/amazon-mq-broker-configuration-parameters.html
                -->
                <!--
                Mirrored queues let you send a copy of each message to a topic with a similar name automatically.
                For more information, see http://activemq.apache.org/mirrored-queues.html

                Virtual destinations let you configure advanced routing of messages between destinations.
                For more information, see http://activemq.apache.org/virtual-destinations.html
                -->
                <!--
                <destinationInterceptors>
                  <mirroredQueue copyMessage="true" postfix=".qmirror" prefix=""/>
                  <virtualDestinationInterceptor>
                    <virtualDestinations>
                      <virtualTopic name="&gt;" prefix="VirtualTopicConsumers.*." selectorAware="false"/>
                      <compositeQueue name="MY.QUEUE">
                        <forwardTo>
                          <queue physicalName="FOO"/>
                          <topic physicalName="BAR"/>
                        </forwardTo>
                      </compositeQueue>
                    </virtualDestinations>
                  </virtualDestinationInterceptor>
                </destinationInterceptors>
                -->
                <!--
                By default, Amazon MQ optimizes for queues with fast consumers:
                Consumers are considered fast if they are able to keep up with the rate of messages generated by producers.
                Consumers are considered slow if a queue builds up a backlog of unacknowledged messages, potentially causing a decrease in producer throughput.
                To instruct Amazon MQ to optimize for queues with slow consumers, set the concurrentStoreAndDispatchQueues attribute to false.
                For more information, see https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/ensuring-effective-amazon-mq-performance.html
                -->
                <!--
                <persistenceAdapter>
                  <kahaDB  concurrentStoreAndDispatchQueues="false"/>
                </persistenceAdapter>
                -->
                <destinationPolicy>
                    <policyMap>
                       <policyEntries>
                      <!--
                      gcInactiveDestinations is used to automatically purge inactive destinations
                      preventing them from unnecessarily using broker resources.

                      An 'inactive' destination is one that has no messages pending and no consumers connected.

                      For more information, see: http://activemq.apache.org/delete-inactive-destinations.html
                      -->
                          <policyEntry gcInactiveDestinations="true"
                                       inactiveTimoutBeforeGC="600000"
                                       topic="&gt;">
                        <!--
                        The constantPendingMessageLimitStrategy is used to prevent
                        slow topic consumers to block producers and affect other consumers
                        by limiting the number of messages that are retained

                        For more information, see: http://activemq.apache.org/slow-consumer-handling.html
                        -->
                             <pendingMessageLimitStrategy>
                                <constantPendingMessageLimitStrategy limit="1000"/>
                             </pendingMessageLimitStrategy>
                          </policyEntry>
                          <policyEntry gcInactiveDestinations="true"
                                       inactiveTimoutBeforeGC="600000"
                                       queue="&gt;"/>
                          <!--
                      Destination policies let you configure a rich set of behaviors for your queues and topics.
                      For more information, see http://activemq.apache.org/per-destination-policies.html
                      -->
                          <!--
                      <policyEntry topic="FOO.&gt;">
                        <dispatchPolicy>
                          <roundRobinDispatchPolicy/>
                        </dispatchPolicy>
                        <subscriptionRecoveryPolicy>
                          <lastImageSubscriptionRecoveryPolicy/>
                        </subscriptionRecoveryPolicy>
                      </policyEntry>
                      <policyEntry advisoryForConsumed="true" tempTopic="true"/>
                      <policyEntry advisoryForConsumed="true" tempQueue="true"/>
                      -->
                       </policyEntries>
                    </policyMap>
                </destinationPolicy>
                <!--
                Typically, destinations are created automatically when they are used. Amazon MQ lets you create destinations when the broker is started.
                For more information, see http://activemq.apache.org/configure-startup-destinations.html
                -->
                <!--
                <destinations>
                  <queue physicalName="FOO.BAR"/>
                  <topic physicalName="SOME.TOPIC"/>
                </destinations>
                -->
                <!--
                You can control advanced ActiveMQ features using plugins.
                -->
                <plugins>
                  <!--
                  The Authorization plugin allows you to control the groups of users that are allowed to perform certain operations on your destinations.
                  For more information, see http://activemq.apache.org/security.html
                  -->
                  <!--
                  <authorizationPlugin>
                    <map>
                      <authorizationMap>
                        <authorizationEntries>
                          <authorizationEntry admin="guests,users" queue="GUEST.&gt;" read="guests" write="guests,users"/>
                          <authorizationEntry admin="guests,users" read="guests,users" topic="ActiveMQ.Advisory.&gt;" write="guests,users"/>
                        </authorizationEntries>
                        <tempDestinationAuthorizationEntry>
                          <tempDestinationAuthorizationEntry admin="tempDestinationAdmins" read="tempDestinationAdmins" write="tempDestinationAdmins"/>
                        </tempDestinationAuthorizationEntry>
                      </authorizationMap>
                    </map>
                  </authorizationPlugin>
                  -->
                  <!--
                  The Discarding DLQ plugin simplifies the configuration of your global dead-letter queue strategy.
                  You can take advantage of a more granular per-destination control by using destination policies.
                  For more information, see http://activemq.apache.org/message-redelivery-and-dlq-handling.html
                  -->
                  <!--
                  <discardingDLQBrokerPlugin dropAll="true" dropTemporaryQueues="true" dropTemporaryTopics="true"/>
                  -->
                  <!--
                  The Force Persistency Mode plugin can override the persistency mode set on messages.
                  -->
                  <!--
                  <forcePersistencyModeBrokerPlugin persistenceFlag="true"/>
                  -->
                  <!--
                  The Redelivery plugin extends the capabilities of destination policies with respect to message redelivery.
                  For more information, see http://activemq.apache.org/message-redelivery-and-dlq-handling.html
                  -->
                  <!--
                  <redeliveryPlugin fallbackToDeadLetter="true" sendToDlqIfMaxRetriesExceeded="true">
                    <redeliveryPolicyMap>
                      <redeliveryPolicyMap>
                        <redeliveryPolicyEntries>
                          <redeliveryPolicy maximumRedeliveries="4" queue="SpecialQueue" redeliveryDelay="10000"/>
                        </redeliveryPolicyEntries>
                        <defaultEntry>
                          <redeliveryPolicy initialRedeliveryDelay="5000" maximumRedeliveries="4" redeliveryDelay="10000"/>
                        </defaultEntry>
                      </redeliveryPolicyMap>
                    </redeliveryPolicyMap>
                  </redeliveryPlugin>
                  -->
                  <!--
                  The Statistics plugin lets you query broker or destination statistics by sending messages to the broker.
                  For more information, see http://activemq.apache.org/statisticsplugin.html
                  -->
                  <!--
                  <statisticsBrokerPlugin/>
                  -->
                  <!--
                  The Timestamping plugin lets the broker use server-side time instead of client-provided time for messages.
                  For more information, see http://activemq.apache.org/timestampplugin.html
                  -->
                  <!--
                  <timeStampingBrokerPlugin ttlCeiling="86400000" zeroExpirationOverride="86400000"/>
                  -->
                </plugins>
                <!--
                Network connectors let you connect brokers into networks of brokers.
                For more information, see Creating and Configuring an Amazon MQ Network of Brokers
                (https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/amazon-mq-creating-configuring-network-of-brokers.html)
                in the Amazon MQ Developer Guide and also Networks of Brokers
                (http://activemq.apache.org/networks-of-brokers.html) in the ActiveMQ documentation.
                -->
                <!--
                <networkConnectors>
                  <networkConnector name="myNetworkConnector" userName="commonUser" uri="masterslave:(ssl://b-1a2b3c4d-1.mq.region.amazonaws.com:61617,ssl://b-1a2b3c4d-2.mq.region.amazonaws.com:61617)"/>
                </networkConnectors>
                -->
                 <networkConnectors>
                    <networkConnector conduitSubscriptions="false"
                                      consumerTTL="1"
                                      messageTTL="-1"
                                      name="QueueConnector_ConnectingBroker_2_To_1"
                                      uri="masterslave:(
            - Fn::Select:
              - 0
              - Fn::GetAtt:
                - Broker1
                - OpenWireEndpoints
            - ','
            - Fn::Select:
              - 1
              - Fn::GetAtt:
                - Broker1
                - OpenWireEndpoints
            - |-
              )"
                                      userName="
            - !Ref 'AmazonMQBrokerUser'
            - |-
              ">
                       <excludedDestinations>
                          <topic physicalName="&gt;"/>
                       </excludedDestinations>
                    </networkConnector>
                    <networkConnector conduitSubscriptions="true"
                                      consumerTTL="1"
                                      messageTTL="-1"
                                      name="TopicConnector_ConnectingBroker_2_To_1"
                                      uri="masterslave:(
            - Fn::Select:
              - 0
              - Fn::GetAtt:
                - Broker1
                - OpenWireEndpoints
            - ','
            - Fn::Select:
              - 1
              - Fn::GetAtt:
                - Broker1
                - OpenWireEndpoints
            - |-
              )"
                                      userName="
            - !Ref 'AmazonMQBrokerUser'
            - |-
              ">
                       <excludedDestinations>
                          <queue physicalName="&gt;"/>
                       </excludedDestinations>
                    </networkConnector>
                    <networkConnector conduitSubscriptions="false"
                                      consumerTTL="1"
                                      messageTTL="-1"
                                      name="QueueConnector_ConnectingBroker_2_To_3"
                                      uri="masterslave:(
            - Fn::Select:
              - 0
              - Fn::GetAtt:
                - Broker3
                - OpenWireEndpoints
            - ','
            - Fn::Select:
              - 1
              - Fn::GetAtt:
                - Broker3
                - OpenWireEndpoints
            - |-
              )"
                                      userName="
            - !Ref 'AmazonMQBrokerUser'
            - |-
              ">
                       <excludedDestinations>
                          <topic physicalName="&gt;"/>
                       </excludedDestinations>
                    </networkConnector>
                    <networkConnector conduitSubscriptions="true"
                                      consumerTTL="1"
                                      messageTTL="-1"
                                      name="TopicConnector_ConnectingBroker_2_To_3"
                                      uri="masterslave:(
            - Fn::Select:
              - 0
              - Fn::GetAtt:
                - Broker3
                - OpenWireEndpoints
            - ','
            - Fn::Select:
              - 1
              - Fn::GetAtt:
                - Broker3
                - OpenWireEndpoints
            - |-
              )"
                                      userName="
            - !Ref 'AmazonMQBrokerUser'
            - |
              ">
                       <excludedDestinations>
                          <queue physicalName="&gt;"/>
                       </excludedDestinations>
                    </networkConnector>
                 </networkConnectors>
                 <transportConnectors>
                    <transportConnector name="openwire" updateClusterClients="true" rebalanceClusterClients="true" updateClusterClientsOnRemove="true"/>
                 </transportConnectors>
              </broker>
      Description: Generated configuration to build a network of brokers.
      EngineType: ACTIVEMQ
      EngineVersion: 5.18
      Name: NoB2Configuration
    Type: AWS::AmazonMQ::Configuration
  Configuration3:
    Properties:
      Data:
        Fn::Base64:
          Fn::Join:
          - ''
          - - |-
              <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
              <broker xmlns="http://activemq.apache.org/schema/core"
                      schedulePeriodForDestinationPurge="10000"
                      start="false">
                <!--
                A configuration contains all of the settings for your ActiveMQ broker, in XML format (similar to ActiveMQ's activemq.xml file).
                You can create a configuration before creating any brokers. You can then apply the configuration to one or more brokers.

                You can use additional attributes for the broker element above. These attributes allow you to configure broker-wide settings.

                For more information, see Configuration and Amazon MQ Broker Configuration Parameters in the Amazon MQ Developer Guide:
                https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/amazon-mq-broker-configuration-parameters.html
                -->
                <!--
                Mirrored queues let you send a copy of each message to a topic with a similar name automatically.
                For more information, see http://activemq.apache.org/mirrored-queues.html

                Virtual destinations let you configure advanced routing of messages between destinations.
                For more information, see http://activemq.apache.org/virtual-destinations.html
                -->
                <!--
                <destinationInterceptors>
                  <mirroredQueue copyMessage="true" postfix=".qmirror" prefix=""/>
                  <virtualDestinationInterceptor>
                    <virtualDestinations>
                      <virtualTopic name="&gt;" prefix="VirtualTopicConsumers.*." selectorAware="false"/>
                      <compositeQueue name="MY.QUEUE">
                        <forwardTo>
                          <queue physicalName="FOO"/>
                          <topic physicalName="BAR"/>
                        </forwardTo>
                      </compositeQueue>
                    </virtualDestinations>
                  </virtualDestinationInterceptor>
                </destinationInterceptors>
                -->
                <!--
                By default, Amazon MQ optimizes for queues with fast consumers:
                Consumers are considered fast if they are able to keep up with the rate of messages generated by producers.
                Consumers are considered slow if a queue builds up a backlog of unacknowledged messages, potentially causing a decrease in producer throughput.
                To instruct Amazon MQ to optimize for queues with slow consumers, set the concurrentStoreAndDispatchQueues attribute to false.
                For more information, see https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/ensuring-effective-amazon-mq-performance.html
                -->
                <!--
                <persistenceAdapter>
                  <kahaDB  concurrentStoreAndDispatchQueues="false"/>
                </persistenceAdapter>
                -->
                <destinationPolicy>
                    <policyMap>
                       <policyEntries>
                      <!--
                      gcInactiveDestinations is used to automatically purge inactive destinations
                      preventing them from unnecessarily using broker resources.

                      An 'inactive' destination is one that has no messages pending and no consumers connected.

                      For more information, see: http://activemq.apache.org/delete-inactive-destinations.html
                      -->
                          <policyEntry gcInactiveDestinations="true"
                                       inactiveTimoutBeforeGC="600000"
                                       topic="&gt;">
                        <!--
                        The constantPendingMessageLimitStrategy is used to prevent
                        slow topic consumers to block producers and affect other consumers
                        by limiting the number of messages that are retained

                        For more information, see: http://activemq.apache.org/slow-consumer-handling.html
                        -->
                             <pendingMessageLimitStrategy>
                                <constantPendingMessageLimitStrategy limit="1000"/>
                             </pendingMessageLimitStrategy>
                          </policyEntry>
                          <policyEntry gcInactiveDestinations="true"
                                       inactiveTimoutBeforeGC="600000"
                                       queue="&gt;"/>
                          <!--
                      Destination policies let you configure a rich set of behaviors for your queues and topics.
                      For more information, see http://activemq.apache.org/per-destination-policies.html
                      -->
                          <!--
                      <policyEntry topic="FOO.&gt;">
                        <dispatchPolicy>
                          <roundRobinDispatchPolicy/>
                        </dispatchPolicy>
                        <subscriptionRecoveryPolicy>
                          <lastImageSubscriptionRecoveryPolicy/>
                        </subscriptionRecoveryPolicy>
                      </policyEntry>
                      <policyEntry advisoryForConsumed="true" tempTopic="true"/>
                      <policyEntry advisoryForConsumed="true" tempQueue="true"/>
                      -->
                       </policyEntries>
                    </policyMap>
                </destinationPolicy>
                <!--
                Typically, destinations are created automatically when they are used. Amazon MQ lets you create destinations when the broker is started.
                For more information, see http://activemq.apache.org/configure-startup-destinations.html
                -->
                <!--
                <destinations>
                  <queue physicalName="FOO.BAR"/>
                  <topic physicalName="SOME.TOPIC"/>
                </destinations>
                -->
                <!--
                You can control advanced ActiveMQ features using plugins.
                -->
                <plugins>
                  <!--
                  The Authorization plugin allows you to control the groups of users that are allowed to perform certain operations on your destinations.
                  For more information, see http://activemq.apache.org/security.html
                  -->
                  <!--
                  <authorizationPlugin>
                    <map>
                      <authorizationMap>
                        <authorizationEntries>
                          <authorizationEntry admin="guests,users" queue="GUEST.&gt;" read="guests" write="guests,users"/>
                          <authorizationEntry admin="guests,users" read="guests,users" topic="ActiveMQ.Advisory.&gt;" write="guests,users"/>
                        </authorizationEntries>
                        <tempDestinationAuthorizationEntry>
                          <tempDestinationAuthorizationEntry admin="tempDestinationAdmins" read="tempDestinationAdmins" write="tempDestinationAdmins"/>
                        </tempDestinationAuthorizationEntry>
                      </authorizationMap>
                    </map>
                  </authorizationPlugin>
                  -->
                  <!--
                  The Discarding DLQ plugin simplifies the configuration of your global dead-letter queue strategy.
                  You can take advantage of a more granular per-destination control by using destination policies.
                  For more information, see http://activemq.apache.org/message-redelivery-and-dlq-handling.html
                  -->
                  <!--
                  <discardingDLQBrokerPlugin dropAll="true" dropTemporaryQueues="true" dropTemporaryTopics="true"/>
                  -->
                  <!--
                  The Force Persistency Mode plugin can override the persistency mode set on messages.
                  -->
                  <!--
                  <forcePersistencyModeBrokerPlugin persistenceFlag="true"/>
                  -->
                  <!--
                  The Redelivery plugin extends the capabilities of destination policies with respect to message redelivery.
                  For more information, see http://activemq.apache.org/message-redelivery-and-dlq-handling.html
                  -->
                  <!--
                  <redeliveryPlugin fallbackToDeadLetter="true" sendToDlqIfMaxRetriesExceeded="true">
                    <redeliveryPolicyMap>
                      <redeliveryPolicyMap>
                        <redeliveryPolicyEntries>
                          <redeliveryPolicy maximumRedeliveries="4" queue="SpecialQueue" redeliveryDelay="10000"/>
                        </redeliveryPolicyEntries>
                        <defaultEntry>
                          <redeliveryPolicy initialRedeliveryDelay="5000" maximumRedeliveries="4" redeliveryDelay="10000"/>
                        </defaultEntry>
                      </redeliveryPolicyMap>
                    </redeliveryPolicyMap>
                  </redeliveryPlugin>
                  -->
                  <!--
                  The Statistics plugin lets you query broker or destination statistics by sending messages to the broker.
                  For more information, see http://activemq.apache.org/statisticsplugin.html
                  -->
                  <!--
                  <statisticsBrokerPlugin/>
                  -->
                  <!--
                  The Timestamping plugin lets the broker use server-side time instead of client-provided time for messages.
                  For more information, see http://activemq.apache.org/timestampplugin.html
                  -->
                  <!--
                  <timeStampingBrokerPlugin ttlCeiling="86400000" zeroExpirationOverride="86400000"/>
                  -->
                </plugins>
                <!--
                Network connectors let you connect brokers into networks of brokers.
                For more information, see Creating and Configuring an Amazon MQ Network of Brokers
                (https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/amazon-mq-creating-configuring-network-of-brokers.html)
                in the Amazon MQ Developer Guide and also Networks of Brokers
                (http://activemq.apache.org/networks-of-brokers.html) in the ActiveMQ documentation.
                -->
                <!--
                <networkConnectors>
                  <networkConnector name="myNetworkConnector" userName="commonUser" uri="masterslave:(ssl://b-1a2b3c4d-1.mq.region.amazonaws.com:61617,ssl://b-1a2b3c4d-2.mq.region.amazonaws.com:61617)"/>
                </networkConnectors>
                -->
                 <networkConnectors>
                    <networkConnector conduitSubscriptions="false"
                                      consumerTTL="1"
                                      messageTTL="-1"
                                      name="QueueConnector_ConnectingBroker_3_To_1"
                                      uri="masterslave:(
            - Fn::Select:
              - 0
              - Fn::GetAtt:
                - Broker1
                - OpenWireEndpoints
            - ','
            - Fn::Select:
              - 1
              - Fn::GetAtt:
                - Broker1
                - OpenWireEndpoints
            - |-
              )"
                                      userName="
            - !Ref 'AmazonMQBrokerUser'
            - |-
              ">
                       <excludedDestinations>
                          <topic physicalName="&gt;"/>
                       </excludedDestinations>
                    </networkConnector>
                    <networkConnector conduitSubscriptions="true"
                                      consumerTTL="1"
                                      messageTTL="-1"
                                      name="TopicConnector_ConnectingBroker_3_To_1"
                                      uri="masterslave:(
            - Fn::Select:
              - 0
              - Fn::GetAtt:
                - Broker1
                - OpenWireEndpoints
            - ','
            - Fn::Select:
              - 1
              - Fn::GetAtt:
                - Broker1
                - OpenWireEndpoints
            - |-
              )"
                                      userName="
            - !Ref 'AmazonMQBrokerUser'
            - |-
              ">
                       <excludedDestinations>
                          <queue physicalName="&gt;"/>
                       </excludedDestinations>
                    </networkConnector>
                    <networkConnector conduitSubscriptions="false"
                                      consumerTTL="1"
                                      messageTTL="-1"
                                      name="QueueConnector_ConnectingBroker_3_To_2"
                                      uri="masterslave:(
            - Fn::Select:
              - 0
              - Fn::GetAtt:
                - Broker2
                - OpenWireEndpoints
            - ','
            - Fn::Select:
              - 1
              - Fn::GetAtt:
                - Broker2
                - OpenWireEndpoints
            - |-
              )"
                                      userName="
            - !Ref 'AmazonMQBrokerUser'
            - |-
              ">
                       <excludedDestinations>
                          <topic physicalName="&gt;"/>
                       </excludedDestinations>
                    </networkConnector>
                    <networkConnector conduitSubscriptions="true"
                                      consumerTTL="1"
                                      messageTTL="-1"
                                      name="TopicConnector_ConnectingBroker_3_To_2"
                                      uri="masterslave:(
            - Fn::Select:
              - 0
              - Fn::GetAtt:
                - Broker2
                - OpenWireEndpoints
            - ','
            - Fn::Select:
              - 1
              - Fn::GetAtt:
                - Broker2
                - OpenWireEndpoints
            - |-
              )"
                                      userName="
            - !Ref 'AmazonMQBrokerUser'
            - |
              ">
                       <excludedDestinations>
                          <queue physicalName="&gt;"/>
                       </excludedDestinations>
                    </networkConnector>
                 </networkConnectors>
                 <transportConnectors>
                    <transportConnector name="openwire" updateClusterClients="true" rebalanceClusterClients="true" updateClusterClientsOnRemove="true"/>
                 </transportConnectors>                 
              </broker>
      Description: Generated configuration to build a network of brokers.
      EngineType: ACTIVEMQ
      EngineVersion: 5.18
      Name: NoB3Configuration
    Type: AWS::AmazonMQ::Configuration

  ConfigurationAssociation1:
    Properties:
      Broker:
        Ref: Broker1
      Configuration:
        Id:
          Ref: Configuration1
        Revision:
          Fn::GetAtt:
          - Configuration1
          - Revision
    Type: AWS::AmazonMQ::ConfigurationAssociation

  ConfigurationAssociation2:
    Properties:
      Broker:
        Ref: Broker2
      Configuration:
        Id:
          Ref: Configuration2
        Revision:
          Fn::GetAtt:
          - Configuration2
          - Revision
    Type: AWS::AmazonMQ::ConfigurationAssociation

  ConfigurationAssociation3:
    Properties:
      Broker:
        Ref: Broker3
      Configuration:
        Id:
          Ref: Configuration3
        Revision:
          Fn::GetAtt:
          - Configuration3
          - Revision
    Type: AWS::AmazonMQ::ConfigurationAssociation

  MQBrokerUserPassword:
    Type: AWS::SSM::Parameter
    Properties:
      Name: MQBrokerUserPassword
      Type: String
      Value: !Join
        - ','
        - - !Ref 'AmazonMQBrokerUser'
          - !Ref 'AmazonMQBrokerPassword'
      Description: SSM Param for broker user and password
 
  C9MQClient:
    Type: AWS::Cloud9::EnvironmentEC2
    Properties:
      AutomaticStopTimeMinutes: 30
      Description: MQ Client Workspace
      InstanceType: m4.large
      ImageId: amazonlinux-2-x86_64
      Name:
        Fn::Join:
        - ''
        - - Ref: AWS::StackName
          - MQClient
      Repositories:
        - PathComponent: /amazon-mq-workshop
          RepositoryUrl: https://github.com/sylvesterkachi/amazon-mq-workshop.git
      SubnetId: !Ref 'PublicSubnet1'
      OwnerArn:
        !If [IsWS, !Sub "arn:${AWS::Partition}:iam::${AWS::AccountId}:assumed-role/${InstanceOwner}", !Ref "AWS::NoValue"]
  MQBuildRole:
    Type: AWS::IAM::Role
    Properties:
      Path: /
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/IAMFullAccess
        - arn:aws:iam::aws:policy/AmazonSSMFullAccess
        - arn:aws:iam::aws:policy/AmazonSSMPatchAssociation
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryFullAccess
        - arn:aws:iam::aws:policy/AmazonECS_FullAccess
        - arn:aws:iam::aws:policy/AmazonEC2FullAccess
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      MaxSessionDuration: 3600
      RoleName: MQBuildRole
      Description: Allows EC2 instances to call AWS services on your behalf.
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
  MQBuildRoleInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref MQBuildRole
  EC2MQBuildInstance:
    Type: AWS::EC2::Instance
    Properties:
      Tenancy: default
      UserData: IyEvYmluL2Jhc2gKeXVtIGluc3RhbGwgZ2l0IC15Cnl1bSBpbnN0YWxsIG1ha2UgLXkKc3VkbyB5dW0gaW5zdGFsbCBkb2NrZXIgLXkKeXVtIGluc3RhbGwgYW1hem9uLWVjci1jcmVkZW50aWFsLWhlbHBlciAteQp5dW0gaW5zdGFsbCBtYXZlbiAteQpnaXQgY2xvbmUgaHR0cHM6Ly9naXRodWIuY29tL2libS1tZXNzYWdpbmcvbXEtY29udGFpbmVyLmdpdApjZCBtcS1jb250YWluZXIKZ2l0IGNoZWNrb3V0IDZiYjE3YTU5MjgzYjFjY2JkMjE0OTVmMTNlYjI3ZDVlMzcxNTg5NGIKc3VkbyBzZXJ2aWNlIGRvY2tlciBzdGFydApzdWRvIG1ha2UgYnVpbGQtZGV2c2VydmVyCnJlZ2lvbj0kKGF3cyBlYzIgZGVzY3JpYmUtYXZhaWxhYmlsaXR5LXpvbmVzIC0tb3V0cHV0IHRleHQgLS1xdWVyeSAnQXZhaWxhYmlsaXR5Wm9uZXNbMF0uW1JlZ2lvbk5hbWVdJykKYWNjb3VudGlkPSQoYXdzIHN0cyBnZXQtY2FsbGVyLWlkZW50aXR5IC0tcXVlcnkgQWNjb3VudCAtLW91dHB1dCB0ZXh0KQphd3MgZWNyIGdldC1sb2dpbi1wYXNzd29yZCAtLXJlZ2lvbiAkcmVnaW9uIHwgc3VkbyBkb2NrZXIgbG9naW4gLS11c2VybmFtZSBBV1MgLS1wYXNzd29yZC1zdGRpbiAkYWNjb3VudGlkLmRrci5lY3IuJHJlZ2lvbi5hbWF6b25hd3MuY29tCmF3cyBlY3IgY3JlYXRlLXJlcG9zaXRvcnkgLS1yZXBvc2l0b3J5LW5hbWUgYW1hem9uLW1xLW1pZ3JhdGlvbi1mcm9tLWlibS1tcS9tcWFkdmFuY2VkLXNlcnZlci1kZXYKYXdzIGVjciBjcmVhdGUtcmVwb3NpdG9yeSAtLXJlcG9zaXRvcnktbmFtZSBhbWF6b24tbXEtbWlncmF0aW9uLWZyb20taWJtLW1xL3NhbXBsZS13aXRoLWF3cy1zc20KYXdzIGVjciBjcmVhdGUtcmVwb3NpdG9yeSAtLXJlcG9zaXRvcnktbmFtZSBhbWF6b24tbXEtbWlncmF0aW9uLWZyb20taWJtLW1xL2xvYWQtZ2VuZXJhdG9yCnN1ZG8gZG9ja2VyIHRhZyBpYm0tbXFhZHZhbmNlZC1zZXJ2ZXItZGV2OjkuNC4wLjAtYW1kNjQgJGFjY291bnRpZC5ka3IuZWNyLiRyZWdpb24uYW1hem9uYXdzLmNvbS9hbWF6b24tbXEtbWlncmF0aW9uLWZyb20taWJtLW1xL21xYWR2YW5jZWQtc2VydmVyLWRldjo5LjQuMC4wCnN1ZG8gZG9ja2VyIHB1c2ggJGFjY291bnRpZC5ka3IuZWNyLiRyZWdpb24uYW1hem9uYXdzLmNvbS9hbWF6b24tbXEtbWlncmF0aW9uLWZyb20taWJtLW1xL21xYWR2YW5jZWQtc2VydmVyLWRldjo5LjQuMC4wCnN1ZG8gZG9ja2VyIHRhZyBpYm0tbXFhZHZhbmNlZC1zZXJ2ZXItZGV2OjkuNC4wLjAtYW1kNjQgJGFjY291bnRpZC5ka3IuZWNyLiRyZWdpb24uYW1hem9uYXdzLmNvbS9hbWF6b24tbXEtbWlncmF0aW9uLWZyb20taWJtLW1xL21xYWR2YW5jZWQtc2VydmVyLWRldjpsYXRlc3QKc3VkbyBkb2NrZXIgcHVzaCAkYWNjb3VudGlkLmRrci5lY3IuJHJlZ2lvbi5hbWF6b25hd3MuY29tL2FtYXpvbi1tcS1taWdyYXRpb24tZnJvbS1pYm0tbXEvbXFhZHZhbmNlZC1zZXJ2ZXItZGV2OmxhdGVzdApjZCAuLgpnaXQgY2xvbmUgaHR0cHM6Ly9naXRodWIuY29tL2F3cy1zYW1wbGVzL2FtYXpvbi1tcS1taWdyYXRpb24tZnJvbS1pYm0tbXEuZ2l0CmNkIGFtYXpvbi1tcS1taWdyYXRpb24tZnJvbS1pYm0tbXEvc2FtcGxlLXdpdGgtYXdzLXNzbQpzZWQgLWkgJ3MvJHthd3MtYWNjb3VudC1pZH0vYXdzYWNjb3VudGlkL2cnIHBvbS54bWwKc2VkIC1pICJzL2F3c2FjY291bnRpZC8kYWNjb3VudGlkL2ciIHBvbS54bWwKc2VkIC1pICdzLyR7YXdzLXJlZ2lvbn0vYXdzcmVnaW9uL2cnIHBvbS54bWwKc2VkIC1pICJzL2F3c3JlZ2lvbi8kcmVnaW9uL2ciIHBvbS54bWwKbXZuIGNsZWFuIGRlcGxveQphd3Mgc3NtIHB1dC1wYXJhbWV0ZXIgLS10eXBlIFNlY3VyZVN0cmluZyAtLW5hbWUgJy9ERVYvSk1TLUJSSURHRS9BTUFaT05NUS9QQVNTV09SRCcgLS12YWx1ZSAnd29ya3Nob3BVc2VyJwphd3Mgc3NtIHB1dC1wYXJhbWV0ZXIgLS10eXBlIFNlY3VyZVN0cmluZyAtLW5hbWUgJy9ERVYvSk1TLUJSSURHRS9JQk1NUS9QQVNTV09SRCcgLS12YWx1ZSAncGFzc3cwcmQnCmNkIC4uL2xvYWQtZ2VuZXJhdG9yCnNlZCAtaSAncy8ke2F3cy1hY2NvdW50LWlkfS9hd3NhY2NvdW50aWQvZycgcG9tLnhtbApzZWQgLWkgInMvYXdzYWNjb3VudGlkLyRhY2NvdW50aWQvZyIgcG9tLnhtbApzZWQgLWkgJ3MvJHthd3MtcmVnaW9ufS9hd3NyZWdpb24vZycgcG9tLnhtbApzZWQgLWkgInMvYXdzcmVnaW9uLyRyZWdpb24vZyIgcG9tLnhtbAptdm4gY2xlYW4gZGVwbG95
      BlockDeviceMappings:
        - Ebs:
            VolumeType: gp3
            Iops: 3000
            VolumeSize: 16
            Encrypted: false
            DeleteOnTermination: true
          DeviceName: /dev/xvda
      IamInstanceProfile: !Ref MQBuildRoleInstanceProfile
      EbsOptimized: false
      NetworkInterfaces:
        - AssociatePublicIpAddress: true
          DeviceIndex: '0'  
      ImageId: !Ref LatestAmiId
      InstanceType: t2.medium
  ECSTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: [ecs-tasks.amazonaws.com]
          Action: ['sts:AssumeRole']
      Path: /
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy

  IBMMQECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: ibm-mq-cluster

  IBMMQECSTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    DependsOn: EC2MQBuildInstance
    Properties:
      Family: ibm-mq-broker-task
      Cpu: 2048
      Memory: 4096
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      ExecutionRoleArn: !Ref ECSTaskExecutionRole
      ContainerDefinitions:
        - Name: mqadvanced-server-dev
          Cpu: 2048
          Memory: 4096
          Image: !Sub '${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/amazon-mq-migration-from-ibm-mq/mqadvanced-server-dev:latest'
          PortMappings:
            - ContainerPort: 1414
            - ContainerPort: 9443
          Environment:
            - Name: LICENSE
              Value: accept
            - Name: MQ_QMGR_NAME
              Value: !Ref IBMMQBrokerQueueManager
            - Name: MQ_ADMIN_PASSWORD
              Value: !Ref IBMMQBrokerPassword
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref CloudWatchLogsGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: ibm-mq-broker-task

  CloudWatchLogsGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: cmr/ecs/ibm-mq-cluster
      RetentionInDays: 30

  IBMMQECSService:
    Type: AWS::ECS::Service
    Properties:
      ServiceName: ibm-mq-broker-service
      Cluster: !Ref IBMMQECSCluster
      LaunchType: FARGATE
      DeploymentConfiguration:
        MaximumPercent: 200
        MinimumHealthyPercent: 100
      DesiredCount: 1
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED
          SecurityGroups:
            - !Ref IBMMQSecurityGroup
          Subnets:
            - !Ref PublicSubnet1
            - !Ref PublicSubnet2
      TaskDefinition: !Ref IBMMQECSTaskDefinition



  SecurityGroupDD263621:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow MQ Access
      SecurityGroupEgress:
        - CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic by default
          IpProtocol: "-1"
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          Description: from 0.0.0.0/0:ALL TRAFFIC
          IpProtocol: "-1"
      VpcId:
        Ref: VPC



  SecretAmazonMQ3005BE0F:
    Type: AWS::SecretsManager::Secret
    Properties:
      Description: This is the secret for my AmazonMQ instance
      GenerateSecretString:
        ExcludeCharacters: '"@/, :=#$%^&*()'
        GenerateStringKey: password
        PasswordLength: 16
        SecretStringTemplate: '{"username": "admin"}'
      Name: AmazonMQSecret
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete

  ProducerAmazonMQBroker:
    Type: AWS::AmazonMQ::Broker
    Properties:
      AuthenticationStrategy: simple
      AutoMinorVersionUpgrade: true
      BrokerName: ProducerBroker
      DeploymentMode: SINGLE_INSTANCE
      EncryptionOptions:
        UseAwsOwnedKey: true
      EngineType: ActiveMQ
      EngineVersion: 5.17.6
      HostInstanceType: mq.t3.micro
      Logs:
        Audit: false
        General: true
      MaintenanceWindowStartTime:
        DayOfWeek: FRIDAY
        TimeOfDay: "17:00"
        TimeZone: UTC
      PubliclyAccessible: true
      SecurityGroups:
        - !Ref 'AmazonMQSecurityGroup'
      SubnetIds:
        - !Ref 'PublicSubnet1'

      Users:
        - ConsoleAccess: true
          Password:
            Fn::Join:
              - ""
              - - "{{resolve:secretsmanager:"
                - Ref: SecretAmazonMQ3005BE0F
                - :SecretString:password}}
          Username:
            Fn::Join:
              - ""
              - - "{{resolve:secretsmanager:"
                - Ref: SecretAmazonMQ3005BE0F
                - :SecretString:username}}

  ConsumerAmazonMQBroker:
    Type: AWS::AmazonMQ::Broker
    Properties:
      AuthenticationStrategy: simple
      AutoMinorVersionUpgrade: true
      BrokerName: ConsumerBroker
      DeploymentMode: SINGLE_INSTANCE
      EncryptionOptions:
        UseAwsOwnedKey: true
      EngineType: ActiveMQ
      EngineVersion: 5.17.6
      HostInstanceType: mq.t3.micro
      Logs:
        Audit: false
        General: true
      MaintenanceWindowStartTime:
        DayOfWeek: FRIDAY
        TimeOfDay: "17:00"
        TimeZone: UTC
      PubliclyAccessible: true
      SecurityGroups:
        - Fn::GetAtt:
            - SecurityGroupDD263621
            - GroupId
      StorageType: efs
      SubnetIds:
        - !Ref 'PublicSubnet1'

      Users:
        - ConsoleAccess: true
          Password:
            Fn::Join:
              - ""
              - - "{{resolve:secretsmanager:"
                - Ref: SecretAmazonMQ3005BE0F
                - :SecretString:password}}
          Username:
            Fn::Join:
              - ""
              - - "{{resolve:secretsmanager:"
                - Ref: SecretAmazonMQ3005BE0F
                - :SecretString:username}}

  FilterAmazonMQBroker:
    Type: AWS::AmazonMQ::Broker
    Properties:
      AuthenticationStrategy: simple
      AutoMinorVersionUpgrade: true
      BrokerName: FilterBroker
      DeploymentMode: SINGLE_INSTANCE
      EncryptionOptions:
        UseAwsOwnedKey: true
      EngineType: ActiveMQ
      EngineVersion: 5.17.6
      HostInstanceType: mq.t3.micro
      Logs:
        Audit: false
        General: true
      MaintenanceWindowStartTime:
        DayOfWeek: FRIDAY
        TimeOfDay: "17:00"
        TimeZone: UTC
      PubliclyAccessible: true
      SecurityGroups:
        - Fn::GetAtt:
            - SecurityGroupDD263621
            - GroupId
      StorageType: efs
      SubnetIds:
        - !Ref 'PublicSubnet1'

      Users:
        - ConsoleAccess: true
          Password:
            Fn::Join:
              - ""
              - - "{{resolve:secretsmanager:"
                - Ref: SecretAmazonMQ3005BE0F
                - :SecretString:password}}
          Username:
            Fn::Join:
              - ""
              - - "{{resolve:secretsmanager:"
                - Ref: SecretAmazonMQ3005BE0F
                - :SecretString:username}}

  FilterBrokerConfiguration:
    Type: AWS::AmazonMQ::Configuration
    Properties:
      Data:
        Fn::Base64:
          Fn::Join:
            - ""
            - - <?xml version="1.0" encoding="UTF-8" standalone="yes"?> <broker schedulePeriodForDestinationPurge="10000" xmlns="http://activemq.apache.org/schema/core"> <destinationInterceptors> <mirroredQueue copyMessage="true" postfix=".qmirror" prefix=""/> <virtualDestinationInterceptor> <virtualDestinations> <virtualTopic name="&gt;" prefix="VirtualTopicConsumers.*." selectorAware="false"/> <compositeQueue name="ALL_INBOUND"> <forwardTo> <filteredDestination queue="NEW_APPLICATION_A_CANADA" selector="message_type = 'new' AND description like '%APPLICATION_A' AND country = 'canada' "/> <filteredDestination queue="NEW_APPLICATION_A_US" selector="message_type = 'new' AND description like '%APPLICATION_A' AND country = 'US' "/> <filteredDestination queue="NEW_APPLICATION_A_UK" selector="message_type = 'new' AND description like '%APPLICATION_A' AND country = 'UK' "/> <filteredDestination queue="NEW_APPLICATION_B_CANADA" selector="message_type = 'new' AND description like '%APPLICATION_B' AND country = 'canada' "/> <filteredDestination queue="NEW_APPLICATION_B_US" selector="message_type = 'new' AND description like '%APPLICATION_B' AND country = 'US' "/> <filteredDestination queue="NEW_APPLICATION_B_UK" selector="message_type = 'new' AND description like '%APPLICATION_B' AND country = 'UK' "/> <filteredDestination queue="NEW_APPLICATION_C_CANADA" selector="message_type = 'new' AND description like '%APPLICATION_C' AND country = 'canada' "/> <filteredDestination queue="NEW_APPLICATION_C_US" selector="message_type = 'new' AND description like '%APPLICATION_C' AND country = 'US' "/> <filteredDestination queue="NEW_APPLICATION_C_UK" selector="message_type = 'new' AND description like '%APPLICATION_C' AND country = 'UK' "/> <filteredDestination queue="NEW_APPLICATION_D_CANADA" selector="message_type = 'new' AND description like '%APPLICATION_D' AND country = 'canada' "/> <filteredDestination queue="NEW_APPLICATION_D_US" selector="message_type = 'new' AND description like '%APPLICATION_D' AND country = 'US' "/> <filteredDestination queue="NEW_APPLICATION_D_UK" selector="message_type = 'new' AND description like '%APPLICATION_D' AND country = 'UK' "/> <filteredDestination queue="NEW_APPLICATION_E_CANADA" selector="message_type = 'new' AND description like '%APPLICATION_E' AND country = 'canada' "/> <filteredDestination queue="NEW_APPLICATION_E_US" selector="message_type = 'new' AND description like '%APPLICATION_E' AND country = 'US' "/> <filteredDestination queue="NEW_APPLICATION_E_UK" selector="message_type = 'new' AND description like '%APPLICATION_E' AND country = 'UK' "/> </forwardTo> </compositeQueue> </virtualDestinations> </virtualDestinationInterceptor> </destinationInterceptors> <destinationPolicy> <policyMap> <policyEntries> <policyEntry gcInactiveDestinations="true" inactiveTimoutBeforeGC="600000" topic="&gt;"> <pendingMessageLimitStrategy> <constantPendingMessageLimitStrategy limit="1000"/> </pendingMessageLimitStrategy> </policyEntry> <policyEntry gcInactiveDestinations="true" inactiveTimoutBeforeGC="600000" queue="&gt;"/> </policyEntries> </policyMap> </destinationPolicy> <plugins> </plugins> <networkConnectors> <networkConnector duplex="true" messageTTL="2" name="ConsumerBroker" networkTTL="2" uri="static:(
              - Fn::Select:
                  - 0
                  - Fn::GetAtt:
                      - ConsumerAmazonMQBroker
                      - OpenWireEndpoints
              - )" userName="admin"/> </networkConnectors> </broker>
      EngineType: ACTIVEMQ
      EngineVersion: 5.17.6
      Name: FilterBrokerConfiguration

  ProducerBrokerConfiguration:
    Type: AWS::AmazonMQ::Configuration
    Properties:
      Data:
        Fn::Base64:
          Fn::Join:
            - ""
            - - <?xml version="1.0" encoding="UTF-8" standalone="yes"?> <broker schedulePeriodForDestinationPurge="10000" xmlns="http://activemq.apache.org/schema/core"> <destinationPolicy> <policyMap> <policyEntries> <policyEntry gcInactiveDestinations="true" inactiveTimoutBeforeGC="600000" topic="&gt;"> <pendingMessageLimitStrategy> <constantPendingMessageLimitStrategy limit="1000"/> </pendingMessageLimitStrategy> </policyEntry> <policyEntry gcInactiveDestinations="true" inactiveTimoutBeforeGC="600000" queue="&gt;"/> </policyEntries> </policyMap> </destinationPolicy> <plugins> </plugins> <networkConnectors> <networkConnector duplex="false" messageTTL="2" name="FilterBroker" networkTTL="2" staticBridge="true" uri="static:(
              - Fn::Select:
                  - 0
                  - Fn::GetAtt:
                      - FilterAmazonMQBroker
                      - OpenWireEndpoints
              - )" userName="admin"> <staticallyIncludedDestinations> <queue physicalName="ALL_INBOUND"/> </staticallyIncludedDestinations> </networkConnector> </networkConnectors> </broker>
      EngineType: ACTIVEMQ
      EngineVersion: 5.17.6
      Name: ProducerBrokerConfiguration

  filterbrokerconfigurationassociation:
    Type: AWS::AmazonMQ::ConfigurationAssociation
    Properties:
      Broker:
        Ref: FilterAmazonMQBroker
      Configuration:
        Id:
          Ref: FilterBrokerConfiguration
        Revision:
          Fn::GetAtt:
            - FilterBrokerConfiguration
            - Revision

  producerbrokerconfigurationassociation:
    Type: AWS::AmazonMQ::ConfigurationAssociation
    Properties:
      Broker:
        Ref: ProducerAmazonMQBroker
      Configuration:
        Id:
          Ref: ProducerBrokerConfiguration
        Revision:
          Fn::GetAtt:
            - ProducerBrokerConfiguration
            - Revision

  PipeRole4D7B8476:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: pipes.amazonaws.com
        Version: "2012-10-17"
      Policies:
        - PolicyDocument:
            Statement:
              - Action:
                  - ec2:CreateNetworkInterface
                  - ec2:DeleteNetworkInterface
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DescribeSecurityGroups
                  - ec2:DescribeSubnets
                  - ec2:DescribeVpcs
                  - events:PutEvents
                  - mq:DescribeBroker
                Effect: Allow
                Resource: "*"
              - Action: secretsmanager:GetSecretValue
                Effect: Allow
                Resource:
                  Ref: SecretAmazonMQ3005BE0F
            Version: "2012-10-17"
          PolicyName: pipe_policy

  amazonmqfilterbusE421663A:
    Type: AWS::Events::EventBus
    Properties:
      Name: MyCustomEventBus

  PipeMQSource:
    Type: AWS::Pipes::Pipe
    Properties:
      RoleArn:
        Fn::GetAtt:
          - PipeRole4D7B8476
          - Arn
      Source:
        Fn::GetAtt:
          - ProducerAmazonMQBroker
          - Arn
      SourceParameters:
        ActiveMQBrokerParameters:
          BatchSize: 10
          Credentials:
            BasicAuth:
              Ref: SecretAmazonMQ3005BE0F
          QueueName: EVENT_BRIDGE_INBOUND
      Target:
        Fn::GetAtt:
          - amazonmqfilterbusE421663A
          - Arn
      TargetParameters:
        EventBridgeEventBusParameters: {}

  NEWAPPLICATIONACANADA9B220AD3:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: NEW_APPLICATION_A_CANADA
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete

  NEWAPPLICATIONACANADAPolicy037813E2:
    Type: AWS::SQS::QueuePolicy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - sqs:GetQueueAttributes
              - sqs:GetQueueUrl
              - sqs:SendMessage
            Condition:
              ArnEquals:
                aws:SourceArn:
                  Fn::GetAtt:
                    - ruleapplicationacanadaDD4163FA
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              Fn::GetAtt:
                - NEWAPPLICATIONACANADA9B220AD3
                - Arn
        Version: "2012-10-17"
      Queues:
        - Ref: NEWAPPLICATIONACANADA9B220AD3

  ruleapplicationacanadaDD4163FA:
    Type: AWS::Events::Rule
    Properties:
      EventBusName:
        Ref: amazonmqfilterbusE421663A
      EventPattern:
        detail:
          properties:
            country:
              - equals-ignore-case: canada
            description:
              - wildcard: "*APPLICATION_A"
      State: ENABLED
      Targets:
        - Arn:
            Fn::GetAtt:
              - NEWAPPLICATIONACANADA9B220AD3
              - Arn
          Id: Target0
    Metadata:
      aws:cdk:path: AmazonmqEventbridgeFilterStack/rule_application_a_canada/Resource
  NEWAPPLICATIONBCANADAC8862ED2:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: NEW_APPLICATION_B_CANADA
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete

  NEWAPPLICATIONBCANADAPolicy397D9A12:
    Type: AWS::SQS::QueuePolicy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - sqs:GetQueueAttributes
              - sqs:GetQueueUrl
              - sqs:SendMessage
            Condition:
              ArnEquals:
                aws:SourceArn:
                  Fn::GetAtt:
                    - ruleapplicationbcanada6A680E78
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              Fn::GetAtt:
                - NEWAPPLICATIONBCANADAC8862ED2
                - Arn
        Version: "2012-10-17"
      Queues:
        - Ref: NEWAPPLICATIONBCANADAC8862ED2

  ruleapplicationbcanada6A680E78:
    Type: AWS::Events::Rule
    Properties:
      EventBusName:
        Ref: amazonmqfilterbusE421663A
      EventPattern:
        detail:
          properties:
            country:
              - equals-ignore-case: canada
            description:
              - wildcard: "*APPLICATION_B"
      State: ENABLED
      Targets:
        - Arn:
            Fn::GetAtt:
              - NEWAPPLICATIONBCANADAC8862ED2
              - Arn
          Id: Target0
    Metadata:
      aws:cdk:path: AmazonmqEventbridgeFilterStack/rule_application_b_canada/Resource
  NEWAPPLICATIONCCANADA05467BFA:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: NEW_APPLICATION_C_CANADA
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete

  NEWAPPLICATIONCCANADAPolicyA0D3FA8F:
    Type: AWS::SQS::QueuePolicy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - sqs:GetQueueAttributes
              - sqs:GetQueueUrl
              - sqs:SendMessage
            Condition:
              ArnEquals:
                aws:SourceArn:
                  Fn::GetAtt:
                    - ruleapplicationccanada19D8549C
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              Fn::GetAtt:
                - NEWAPPLICATIONCCANADA05467BFA
                - Arn
        Version: "2012-10-17"
      Queues:
        - Ref: NEWAPPLICATIONCCANADA05467BFA

  ruleapplicationccanada19D8549C:
    Type: AWS::Events::Rule
    Properties:
      EventBusName:
        Ref: amazonmqfilterbusE421663A
      EventPattern:
        detail:
          properties:
            country:
              - equals-ignore-case: canada
            description:
              - wildcard: "*APPLICATION_C"
      State: ENABLED
      Targets:
        - Arn:
            Fn::GetAtt:
              - NEWAPPLICATIONCCANADA05467BFA
              - Arn
          Id: Target0
  NEWAPPLICATIONDCANADA9B7EC7C2:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: NEW_APPLICATION_D_CANADA
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete

  NEWAPPLICATIONDCANADAPolicy5E2B9040:
    Type: AWS::SQS::QueuePolicy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - sqs:GetQueueAttributes
              - sqs:GetQueueUrl
              - sqs:SendMessage
            Condition:
              ArnEquals:
                aws:SourceArn:
                  Fn::GetAtt:
                    - ruleapplicationdcanada1AD45968
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              Fn::GetAtt:
                - NEWAPPLICATIONDCANADA9B7EC7C2
                - Arn
        Version: "2012-10-17"
      Queues:
        - Ref: NEWAPPLICATIONDCANADA9B7EC7C2
    Metadata:
      aws:cdk:path: AmazonmqEventbridgeFilterStack/NEW_APPLICATION_D_CANADA/Policy/Resource
  ruleapplicationdcanada1AD45968:
    Type: AWS::Events::Rule
    Properties:
      EventBusName:
        Ref: amazonmqfilterbusE421663A
      EventPattern:
        detail:
          properties:
            country:
              - equals-ignore-case: canada
            description:
              - wildcard: "*APPLICATION_D"
      State: ENABLED
      Targets:
        - Arn:
            Fn::GetAtt:
              - NEWAPPLICATIONDCANADA9B7EC7C2
              - Arn
          Id: Target0
    Metadata:
      aws:cdk:path: AmazonmqEventbridgeFilterStack/rule_application_d_canada/Resource
  NEWAPPLICATIONECANADA86CF6947:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: NEW_APPLICATION_E_CANADA
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: AmazonmqEventbridgeFilterStack/NEW_APPLICATION_E_CANADA/Resource
  NEWAPPLICATIONECANADAPolicyB65D48A3:
    Type: AWS::SQS::QueuePolicy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - sqs:GetQueueAttributes
              - sqs:GetQueueUrl
              - sqs:SendMessage
            Condition:
              ArnEquals:
                aws:SourceArn:
                  Fn::GetAtt:
                    - ruleapplicationecanadaED1B9C07
                    - Arn
            Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Resource:
              Fn::GetAtt:
                - NEWAPPLICATIONECANADA86CF6947
                - Arn
        Version: "2012-10-17"
      Queues:
        - Ref: NEWAPPLICATIONECANADA86CF6947
  ruleapplicationecanadaED1B9C07:
    Type: AWS::Events::Rule
    Properties:
      EventBusName:
        Ref: amazonmqfilterbusE421663A
      EventPattern:
        detail:
          properties:
            country:
              - equals-ignore-case: canada
            description:
              - wildcard: "*APPLICATION_E"
      State: ENABLED
      Targets:
        - Arn:
            Fn::GetAtt:
              - NEWAPPLICATIONECANADA86CF6947
              - Arn
          Id: Target0

Mappings:
  LatestNodeRuntimeMap:
    af-south-1:
      value: nodejs20.x
    ap-east-1:
      value: nodejs20.x
    ap-northeast-1:
      value: nodejs20.x
    ap-northeast-2:
      value: nodejs20.x
    ap-northeast-3:
      value: nodejs20.x
    ap-south-1:
      value: nodejs20.x
    ap-south-2:
      value: nodejs20.x
    ap-southeast-1:
      value: nodejs20.x
    ap-southeast-2:
      value: nodejs20.x
    ap-southeast-3:
      value: nodejs20.x
    ap-southeast-4:
      value: nodejs20.x
    ap-southeast-5:
      value: nodejs20.x
    ap-southeast-7:
      value: nodejs20.x
    ca-central-1:
      value: nodejs20.x
    ca-west-1:
      value: nodejs20.x
    cn-north-1:
      value: nodejs18.x
    cn-northwest-1:
      value: nodejs18.x
    eu-central-1:
      value: nodejs20.x
    eu-central-2:
      value: nodejs20.x
    eu-north-1:
      value: nodejs20.x
    eu-south-1:
      value: nodejs20.x
    eu-south-2:
      value: nodejs20.x
    eu-west-1:
      value: nodejs20.x
    eu-west-2:
      value: nodejs20.x
    eu-west-3:
      value: nodejs20.x
    il-central-1:
      value: nodejs20.x
    me-central-1:
      value: nodejs20.x
    me-south-1:
      value: nodejs20.x
    mx-central-1:
      value: nodejs20.x
    sa-east-1:
      value: nodejs20.x
    us-east-1:
      value: nodejs20.x
    us-east-2:
      value: nodejs20.x
    us-west-1:
      value: nodejs20.x
    us-west-2:
      value: nodejs20.x



Outputs:
  ECSTaskExecutionRole:
    Description: The ARN of the ECS Task Execution Role.
    Value: !Ref ECSTaskExecutionRole
    Export:
      Name: !Sub '${Stage}:JMS-BRIDGE:ECSTaskExecutionRole'
  ECSTaskRole:
    Description: The ARN of the ECS Task Role.
    Value: !Ref ECSTaskRole
    Export:
      Name: !Sub '${Stage}:JMS-BRIDGE:ECSTaskRole'
  ServiceAutoScalingRole:
    Description: The ARN of the Service Auto Scaling Role.
    Value: !GetAtt ServiceAutoScalingRole.Arn
    Export:
      Name: !Sub '${Stage}:JMS-BRIDGE:ServiceAutoScalingRole'
  VPCRef:
    Description: The reference to the created VPC.
    Value: !Ref VPC
    Export:
      Name: !Sub '${Stage}:JMS-BRIDGE:VPC'
  PublicSubnet1Ref:
    Description: The reference to the created public subnet 1.
    Value: !Ref PublicSubnet1
    Export:
      Name: !Sub '${Stage}:JMS-BRIDGE:PublicSubnet1'

  PublicSubnet2Ref:
    Description: The reference to the created public subnet 2.
    Value: !Ref PublicSubnet2
    Export:
      Name: !Sub '${Stage}:JMS-BRIDGE:PublicSubnet2'

  AmazonMQBrokerUserNameRef:
    Description: The reference to the Amazon MQ broker user name.
    Value: !Ref AmazonMQBrokerUser
    Export:
      Name: !Sub '${Stage}:JMS-BRIDGE:AmazonMQBrokerUserName'

  AmazonMQBrokerPasswordRef:
    Description: The reference to the Amazon MQ broker user password.
    Value: !Ref AmazonMQBrokerPassword
    Export:
      Name: !Sub '${Stage}:JMS-BRIDGE:AmazonMQBrokerPassword'

  AmazonMQBrokerURLRef:
    Description: The reference to the Amazon MQ broker OpenWire URL.
    Value: !Sub 'failover:(ssl://${AmazonMQBrokerMigration}-1.mq.${AWS::Region}.amazonaws.com:61617)'
    Export:
      Name: !Sub '${Stage}:JMS-BRIDGE:AmazonMQBrokerURL'
      
  IBMMQBrokerUserNameRef:
    Description: The reference to the IBM MQ broker application user name.
    Value: 'admin'
    Export:
      Name: !Sub '${Stage}:JMS-BRIDGE:IBMMQBrokerUserName'

  IBMMQBrokerPasswordRef:
    Description: The reference to the IBM MQ broker application user password.
    Value: !Ref IBMMQBrokerPassword
    Export:
      Name: !Sub '${Stage}:JMS-BRIDGE:IBMMQBrokerPassword'

  IBMMQBrokerQueueManagerRef:
    Description: The reference to the IBM MQ broker queue manager.
    Value: !Ref IBMMQBrokerQueueManager
    Export:
      Name: !Sub '${Stage}:JMS-BRIDGE:IBMMQBrokerQueueManager'

  IBMMQBrokerChannelRef:
    Description: The reference to the IBM MQ broker channel.
    Value: 'DEV.ADMIN.SVRCONN'
    Export:
      Name: !Sub '${Stage}:JMS-BRIDGE:IBMMQBrokerChannel'






  AmazonMQSecretARN:
    Value:
      Ref: SecretAmazonMQ3005BE0F
  ProducerBrokerHost:
    Value:
      Fn::Join:
        - ""
        - - Ref: ProducerAmazonMQBroker
          - -1.mq.us-east-1.amazonaws.com
  ConsumerBrokerHost:
    Value:
      Fn::Join:
        - ""
        - - Ref: ConsumerAmazonMQBroker
          - -1.mq.us-east-1.amazonaws.com
  FilterBrokerHost:
    Value:
      Fn::Join:
        - ""
        - - Ref: FilterAmazonMQBroker
          - -1.mq.us-east-1.amazonaws.com
  ProducerBrokerConsole:
    Value:
      Fn::Join:
        - ""
        - - https://us-east-1.console.amazonaws.com/amazonmq/home?region=us-east-1#/brokers/
          - Ref: ProducerAmazonMQBroker
          - "-1"
  ConsumerBrokerConsole:
    Value:
      Fn::Join:
        - ""
        - - https://us-east-1.console.amazonaws.com/amazonmq/home?region=us-east-1#/brokers/
          - Ref: ConsumerAmazonMQBroker
          - "-1"
  FilterBrokerConsole:
    Value:
      Fn::Join:
        - ""
        - - https://us-east-1.console.amazonaws.com/amazonmq/home?region=us-east-1#/brokers/
          - Ref: FilterAmazonMQBroker
          - "-1"
  AMQProducerURL:
    Description: Producer Broker OpenWire SSL Endpoint
    Value:
      Fn::Join:
        - ""
        - - ssl://
          - Ref: ProducerAmazonMQBroker
          - -1.mq.us-east-1.amazonaws.com:61617
  AMQConsumerURL:
    Description: Consumer Broker OpenWire SSL Endpoint
    Value:
      Fn::Join:
        - ""
        - - ssl://
          - Ref: ConsumerAmazonMQBroker
          - -1.mq.us-east-1.amazonaws.com:61617
  AMQProducerBrokerConsoleURL:
    Description: Producer Broker Web Console URL
    Value:
      Fn::Join:
        - ""
        - - https://
          - Ref: ProducerAmazonMQBroker
          - -1.mq.us-east-1.amazonaws.com:8162
  AMQConsumerBrokerConsoleURL:
    Description: Consumer Broker Web Console URL
    Value:
      Fn::Join:
        - ""
        - - https://
          - Ref: ConsumerAmazonMQBroker
          - -1.mq.us-east-1.amazonaws.com:8162
  AMQFilterBrokerConsoleURL:
    Description: Filter Broker Web Console URL
    Value:
      Fn::Join:
        - ""
        - - https://
          - Ref: FilterAmazonMQBroker
          - -1.mq.us-east-1.amazonaws.com:8162
  AMQProducerBrokerURL:
    Description: Producer Broker OpenWire Endpoints
    Value:
      Fn::Join:
        - ","
        - Fn::GetAtt:
            - ProducerAmazonMQBroker
            - OpenWireEndpoints
  AMQConsumerBrokerURL:
    Description: Consumer Broker OpenWire Endpoints
    Value:
      Fn::Join:
        - ","
        - Fn::GetAtt:
            - ConsumerAmazonMQBroker
            - OpenWireEndpoints
  ApplicationACanadaQueueUrl:
    Description: Application A Canada Queue URL
    Value:
      Fn::Join:
        - ""
        - - https://sqs.
          - Ref: AWS::Region
          - .amazonaws.com/
          - Ref: AWS::AccountId
          - /NEW_APPLICATION_A_CANADA
  ApplicationBCanadaQueueUrl:
    Description: Application B Canada Queue URL
    Value:
      Fn::Join:
        - ""
        - - https://sqs.
          - Ref: AWS::Region
          - .amazonaws.com/
          - Ref: AWS::AccountId
          - /NEW_APPLICATION_B_CANADA
  ApplicationCCanadaQueueUrl:
    Description: Application C Canada Queue URL
    Value:
      Fn::Join:
        - ""
        - - https://sqs.
          - Ref: AWS::Region
          - .amazonaws.com/
          - Ref: AWS::AccountId
          - /NEW_APPLICATION_C_CANADA
  ApplicationDCanadaQueueUrl:
    Description: Application D Canada Queue URL
    Value:
      Fn::Join:
        - ""
        - - https://sqs.
          - Ref: AWS::Region
          - .amazonaws.com/
          - Ref: AWS::AccountId
          - /NEW_APPLICATION_D_CANADA
  ApplicationECanadaQueueUrl:
    Description: Application E Canada Queue URL
    Value:
      Fn::Join:
        - ""
        - - https://sqs.
          - Ref: AWS::Region
          - .amazonaws.com/
          - Ref: AWS::AccountId
          - /NEW_APPLICATION_E_CANADA
